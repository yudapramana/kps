import{y as S,z as rt,A as c,O as z,V as ut,B as n,C as i,D as s,I,J as r,K as m,H as U,S as j,aB as G,U as v,ay as b,a as N,as as dt}from"./AuthUserStore-67h2FHdL.js";import{S as E}from"./sweetalert2.esm.all-9Qm2jZ7z.js";import{_ as ct}from"./app-CZBZEz52.js";const mt={class:"content-header"},vt={class:"container-fluid"},pt={class:"d-flex justify-content-between align-items-center"},_t={class:"mb-0 text-muted text-sm"},ft={key:0,class:"text-muted text-sm mt-1"},gt={class:"badge badge-light border"},bt=["disabled"],ht={class:"content"},yt={class:"container-fluid"},xt={class:"card"},kt={class:"card-header"},wt={class:"form-row"},St={class:"form-group col-md-6 mb-2"},Mt=["disabled"],Ct=["label"],It=["value"],Nt={class:"form-group col-md-6 mb-2"},Bt={class:"text-sm mb-1"},$t=["disabled"],At={value:"",disabled:""},Vt=["label"],Tt={disabled:"",class:"opt-contingent-header"},Dt=["value"],Pt={key:0,class:"card mt-3"},Lt={class:"card-header d-flex justify-content-between align-items-center py-2"},Ut={class:"text-sm"},jt=["disabled"],Et={key:0,class:"card-body text-center py-3"},Ft={key:1,class:"card-body p-0 table-responsive"},Kt={class:"table table-bordered table-sm table-compact mb-0"},Ot={class:"thead-light"},Rt=["colspan"],Jt={class:"font-weight-bold text-sm"},Yt={class:"py-1"},zt={class:"text-sm"},Gt={class:"text-muted text-xs"},Ht=["max","onUpdate:modelValue","onInput","disabled"],Wt={class:"text-muted text-xxs mt-1"},qt={key:1,class:"badge badge-light border badge-xs"},Qt={class:"bg-light"},Xt={class:"badge badge-primary badge-sm"},Zt={class:"card-footer py-2 text-right"},te={key:0,class:"alert alert-warning py-1 px-2 mb-2 text-sm"},ee=["disabled"],se={key:0,class:"fas fa-spinner fa-spin mr-1"},ae=["disabled"],ne={key:1,class:"alert alert-info mt-3"},H=3,ie={__name:"EventCompetitionScoringV2",setup(oe){const W=(e,t)=>{let o=Number(x.value[e][t.id].score??0);o<0&&(o=0),t.max_score>0&&o>t.max_score&&(o=t.max_score),x.value[e][t.id].score=o},q=e=>f.value.filter(t=>L(t.id,e)).map(t=>Number(x.value[t.id][e.id].score??0)),F=e=>{const t=q(e);if(t.length<2)return!0;const o=Math.min(...t);return Math.max(...t)-o<=H},D=S(()=>M.value.every(e=>F(e))),Q=rt(),K=S(()=>{var e;return(e=Q.eventData)==null?void 0:e.id}),h=c(""),y=c(""),O=c([]),P=c([]),_=c(null),k=c(null),x=c({}),A=c(!1),V=c(!1),T=c(!1),w=c(!1),p=c("draft"),B=S(()=>{var e,t;return(t=(e=_.value)==null?void 0:e.event_group)==null?void 0:t.is_team}),f=S(()=>{var e;return((e=k.value)==null?void 0:e.judges)||[]}),M=S(()=>{var e;return((e=k.value)==null?void 0:e.components)||[]}),X=e=>{var a,l,d;if(B.value)return e.team_name||e.contingent||"Tim";const t=((a=e.participant)==null?void 0:a.participant_number)||"-",o=((l=e.participant)==null?void 0:l.full_name)||"-",u=((d=e.participant)==null?void 0:d.nik)||"";return u?`${t} - ${o} (${u})`:`${t} - ${o}`},R=(e="")=>e?e.trim().split(/\s+/).slice(0,2).map(t=>t[0].toUpperCase()).join(""):"",Z=S(()=>f.value.map(e=>R(e.name)).join(", ")),tt=S(()=>{var o,u;const e=P.value||[],t=new Map;for(const a of e){const l=((o=a.event_category)==null?void 0:o.full_name)||"Tanpa Kategori",d=String(((u=a.event_category)==null?void 0:u.id)||l);t.has(d)||t.set(d,{id:d,name:l,count:0,contingents:new Map});const C=t.get(d);C.count++;const g=a.contingent||"-";C.contingents.has(g)||C.contingents.set(g,{name:g,count:0,items:[]});const $=C.contingents.get(g);$.count++,$.items.push(a)}return Array.from(t.values()).map(a=>({id:a.id,name:a.name,count:a.count,contingents:Array.from(a.contingents.values())}))}),L=(e,t)=>{var o,u;return((u=(o=k.value)==null?void 0:o.event_group)==null?void 0:u.judge_assignment_mode)==="BY_PANEL"?!0:t.assigned_judge_ids?t.assigned_judge_ids.includes(e):!1},J=(e,t)=>{const o=M.value.find(a=>a.id===t);return((x.value[e][t].score||0)*(o.weight/100)).toFixed(2)},et=e=>{let t=0;for(const o of M.value)L(e,o)&&(t+=Number(J(e,o.id)));return t.toFixed(2)},st=async()=>{A.value=!0;const{data:e}=await N.get(`/api/v1/events/${K.value}/competitions/tree`);O.value=e.rounds||[],A.value=!1},at=async()=>{const{data:e}=await N.get(`/api/v1/event-competitions/${h.value}`);_.value=e},nt=async()=>{V.value=!0;const{data:e}=await N.get(`/api/v1/events/${K.value}/participants/simple`,{params:{event_group_id:_.value.event_group_id,is_team:B.value?1:0}});P.value=e.data||[],V.value=!1},Y=async()=>{var a;T.value=!0;const{data:e}=await N.get(`/api/v1/event-competitions/${h.value}/scoring/form-v2`,{params:{event_participant_id:y.value}});k.value=e;const t=(a=e.scoresheets)==null?void 0:a[0];p.value=(t==null?void 0:t.status)||"draft";const o=e.scoresheets||[],u={};for(const l of f.value){const d=o.find(g=>g.event_judge_id===l.id),C=(d==null?void 0:d.items)||[];u[l.id]={};for(const g of M.value){const $=C.find(lt=>lt.event_field_component_id===g.id);u[l.id][g.id]={score:$?Number($.score):0}}}x.value=u,T.value=!1},it=async()=>{w.value=!0;const e=f.value.map(t=>({event_judge_id:t.id,items:Object.entries(x.value[t.id]).map(([o,u])=>({event_field_component_id:o,score:u.score}))}));await N.post(`/api/v1/event-competitions/${h.value}/scoring/draft-v2`,{event_participant_id:y.value,rows:e}),E.fire("Berhasil","Draft tersimpan","success"),p.value="draft",w.value=!1},ot=async()=>{(await E.fire({title:"Submit Nilai?",text:"Setelah submit, nilai tidak dapat diubah.",icon:"warning",showCancelButton:!0,confirmButtonText:"Ya, Submit",cancelButtonText:"Batal"})).isConfirmed&&(w.value=!0,await N.post(`/api/v1/event-competitions/${h.value}/scoring/submit-v2`,{event_participant_id:y.value}),p.value="submitted",E.fire("Berhasil","Nilai berhasil disubmit","success"),w.value=!1)};return z(h,async e=>{y.value="",_.value=null,P.value=[],k.value=null,e&&(await at(),await nt())}),z(y,async e=>{k.value=null,e&&await Y()}),ut(st),(e,t)=>{var o,u;return i(),n(v,null,[s("section",mt,[s("div",vt,[s("div",pt,[s("div",null,[t[6]||(t[6]=s("h1",{class:"mb-1"},"Input Nilai Kompetisi",-1)),s("p",_t," Pilih kompetisi dan "+r(B.value?"tim":"peserta")+", lalu input nilai sesuai penugasan majelis hakim. ",1),_.value?(i(),n("div",ft,[t[3]||(t[3]=m(" Group: ")),s("strong",null,r(_.value.event_group.full_name),1),t[4]||(t[4]=m(" • Mode: ")),s("span",{class:U(["badge",_.value.event_group.judge_assignment_mode==="BY_PANEL"?"badge-info":"badge-warning"])},r(_.value.event_group.judge_assignment_mode),3),t[5]||(t[5]=m(" • ")),s("span",gt,r(B.value?"TEAM":"INDIVIDUAL"),1)])):I("",!0)]),s("button",{class:"btn btn-sm btn-outline-secondary",disabled:A.value,onClick:t[0]||(t[0]=(...a)=>e.reloadAll&&e.reloadAll(...a))},t[7]||(t[7]=[s("i",{class:"fas fa-sync mr-1"},null,-1),m(" Refresh ")]),8,bt)])])]),s("section",ht,[s("div",yt,[s("div",xt,[s("div",kt,[s("div",wt,[s("div",St,[t[9]||(t[9]=s("label",{class:"text-sm mb-1"},"Kompetisi *",-1)),j(s("select",{"onUpdate:modelValue":t[1]||(t[1]=a=>h.value=a),class:"form-control form-control-sm",disabled:A.value},[t[8]||(t[8]=s("option",{value:"",disabled:""},"-- Pilih Kompetisi --",-1)),(i(!0),n(v,null,b(O.value,a=>(i(),n("optgroup",{key:a.id,label:a.name},[(i(!0),n(v,null,b(a.competitions,l=>(i(),n("option",{key:l.id,value:String(l.id)},r(l.full_name),9,It))),128))],8,Ct))),128))],8,Mt),[[G,h.value]])]),s("div",Nt,[s("label",Bt,r(B.value?"Tim":"Peserta")+" * ",1),j(s("select",{"onUpdate:modelValue":t[2]||(t[2]=a=>y.value=a),class:"form-control form-control-sm",disabled:!_.value||V.value},[s("option",At,r(V.value?"Memuat...":"-- Pilih --"),1),(i(!0),n(v,null,b(tt.value,a=>(i(),n("optgroup",{key:a.id,label:`${a.name} (${a.count})`},[(i(!0),n(v,null,b(a.contingents,l=>(i(),n(v,{key:l.name},[s("option",Tt," — "+r(l.name)+" ("+r(l.count)+") ",1),(i(!0),n(v,null,b(l.items,d=>(i(),n("option",{key:d.id,value:String(d.id)},r(X(d,a.name,l.name)),9,Dt))),128))],64))),128))],8,Vt))),128))],8,$t),[[G,y.value]])])])])]),h.value&&y.value?(i(),n("div",Pt,[s("div",Lt,[s("strong",Ut,r(((u=(o=k.value)==null?void 0:o.competition)==null?void 0:u.full_name)||"Form Penilaian"),1),s("span",{class:U(["badge ml-2",{"badge-secondary":p.value==="draft","badge-success":p.value==="submitted","badge-dark":p.value==="locked"}])},r(p.value.toUpperCase()),3),s("button",{class:"btn btn-xs btn-outline-primary",disabled:T.value,onClick:Y},t[10]||(t[10]=[s("i",{class:"fas fa-sync"},null,-1)]),8,jt)]),T.value?(i(),n("div",Et,t[11]||(t[11]=[s("i",{class:"fas fa-spinner fa-spin mr-1"},null,-1),m(" Memuat form... ")]))):f.value.length&&M.value.length?(i(),n("div",Ft,[s("table",Kt,[s("thead",Ot,[s("tr",null,[t[12]||(t[12]=s("th",{class:"py-1"},null,-1)),s("th",{colspan:f.value.length,class:"text-center py-1 text-sm font-weight-bold"}," Majelis Dewan Hakim ("+r(Z.value)+") ",9,Rt)]),s("tr",null,[t[13]||(t[13]=s("th",{style:{"min-width":"240px"},class:"py-1"},"Komponen",-1)),(i(!0),n(v,null,b(f.value,a=>(i(),n("th",{key:a.id,class:"text-center py-1",style:{"min-width":"70px"}},[s("div",Jt,r(R(a.name)),1)]))),128))])]),s("tbody",null,[(i(!0),n(v,null,b(M.value,a=>(i(),n("tr",{key:a.id,class:U({"table-warning":!F(a)})},[s("td",Yt,[s("strong",zt,r(a.field_name),1),s("div",Gt," Max "+r(a.max_score)+" • "+r(a.weight)+"% ",1)]),(i(!0),n(v,null,b(f.value,l=>(i(),n("td",{key:l.id,class:"text-center py-1"},[L(l.id,a)?(i(),n(v,{key:0},[j(s("input",{type:"number",class:"form-control form-control-xs text-center mx-auto",style:{width:"60px"},min:"0",max:a.max_score,"onUpdate:modelValue":d=>x.value[l.id][a.id].score=d,onInput:d=>W(l.id,a),disabled:p.value!=="draft"},null,40,Ht),[[dt,x.value[l.id][a.id].score,void 0,{number:!0}]]),s("div",Wt," W: "+r(J(l.id,a.id)),1)],64)):(i(),n("span",qt," – "))]))),128))],2))),128)),s("tr",Qt,[t[14]||(t[14]=s("td",{class:"text-right font-weight-bold py-1 text-sm"}," TOTAL ",-1)),(i(!0),n(v,null,b(f.value,a=>(i(),n("td",{key:a.id,class:"text-center py-1"},[s("span",Xt,r(et(a.id)),1)]))),128))])])])])):I("",!0),s("div",Zt,[D.value?I("",!0):(i(),n("div",te,[t[15]||(t[15]=m(" Selisih nilai antar hakim pada satu komponen tidak boleh lebih dari ")),s("strong",null,r(H)),t[16]||(t[16]=m(" poin. "))])),p.value==="draft"?(i(),n("button",{key:1,class:"btn btn-sm btn-primary",disabled:w.value||!D.value,onClick:it},[w.value?(i(),n("i",se)):I("",!0),t[17]||(t[17]=m(" Simpan Draft "))],8,ee)):I("",!0),p.value==="draft"?(i(),n("button",{key:2,class:"btn btn-sm btn-success mr-2",disabled:w.value||!D.value,onClick:ot},t[18]||(t[18]=[s("i",{class:"fas fa-paper-plane mr-1"},null,-1),m(" Submit ")]),8,ae)):I("",!0)])])):(i(),n("div",ne,t[19]||(t[19]=[m(" Pilih "),s("strong",null,"kompetisi",-1),m(" dan "),s("strong",null,"peserta/tim",-1),m(" untuk mulai input nilai. ")])))])])],64)}}},de=ct(ie,[["__scopeId","data-v-332d852a"]]);export{de as default};
