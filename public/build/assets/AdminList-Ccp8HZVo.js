import{F as n,P as m,Q as u,R as e,U as r,Z as C,x as L,a5 as M,aw as G,O as ce,G as K,B as J,J as me,ah as N,ap as Q,T as j,S as B,W as Y,av as ve,_ as pe,ay as ge}from"./pinia-BDOwh8JO.js";import{u as X,b as I,e as Z}from"./app-Cc4vFrcH.js";import{u as ee}from"./toastr-DWkeCtk6.js";import{u as fe}from"./MasterDataStore-CM6auH0g.js";import{f as he}from"./helper-D4kaxrhs.js";const be=["checked"],_e={class:"text-muted m-0 p-0",style:{"font-size":"small !important"}},ye={width:"20%"},ke=["value","selected"],xe={__name:"AdminRow",props:{user:{type:Object,required:!0},index:{type:Number,required:!0},selectAll:{type:Boolean,default:!1}},emits:["userDeleted","editUser","confirmUserDeletion","toggleSelection"],setup(i,{emit:D}){const b=ee(),T=X(),g=i,U=D,s=n([{name:"SUPERADMIN",value:1},{name:"ADMIN",value:2},{name:"USER",value:3},{name:"REVIEWER",value:4}]),k=(w,x)=>{I.patch(`/api/users/${w.id}/change-role`,{role:x}).then(()=>{b.success("Role berhasil diubah"),U("userDeleted")}).catch(d=>{var o,_;b.error(((_=(o=d==null?void 0:d.response)==null?void 0:o.data)==null?void 0:_.message)||"Gagal mengubah role")})},R=()=>{U("toggleSelection",g.user)};return(w,x)=>{var d;return u(),m("tr",null,[e("td",null,[e("input",{type:"checkbox",checked:i.selectAll,onChange:R},null,40,be)]),e("td",null,r(i.index+1),1),e("td",null,[C(r(i.user.name)+" ",1),e("p",_e,r(i.user.jabatan)+" pada "+r(i.user.org_name),1)]),e("td",null,r(i.user.email),1),e("td",ye,[((d=L(T).user)==null?void 0:d.role)==="SUPERADMIN"?(u(),m("select",{key:0,name:"role",id:"role",class:"form-control",style:{width:"200px"},onChange:x[0]||(x[0]=o=>k(i.user,o.target.value))},[(u(!0),m(M,null,G(s.value,o=>(u(),m("option",{key:o.value,value:o.value,selected:i.user.role===o.name},r(o.name),9,ke))),128))],32)):(u(),m(M,{key:1},[C(r(i.user.role),1)],64))])])}}},Se=ce("TableIndexStore",()=>{const i=n(0);return{tableIndex:i,incrementIndex:()=>{i.value=i.value+1}}}),Ue={class:"content-header"},Re={class:"container-fluid"},Ee={class:"d-flex justify-content-between align-items-center"},Ie={class:"btn-group"},Me=["disabled"],De={class:"content"},we={class:"container-fluid"},Pe={class:"card"},Ae={class:"card-header"},Ne={class:"card-body table-responsive p-0"},Ce={class:"table table-bordered table-hover text-sm"},Te={class:"thead-light"},$e={style:{width:"36px"}},Ve=["checked"],je={key:0},Be={key:1},Le={class:"card-footer clearfix"},Ge={class:"d-flex justify-content-between align-items-center"},We={class:"text-muted"},Fe={class:"pagination pagination-sm m-0"},ze={class:"page-item disabled"},He={class:"page-link"},Oe={class:"modal fade",id:"adminPromoteModal",tabindex:"-1",role:"dialog"},qe={class:"modal-dialog modal-lg",role:"document"},Ke={class:"modal-content"},Je={class:"modal-body pt-2"},Qe={class:"form-group mb-2"},Ye={class:"table-responsive border rounded"},Ze={class:"table table-sm m-0"},Xe={key:0},et={key:1},tt=["onClick"],at=["value"],lt={class:"text-muted",style:{"font-size":"12px"}},st={class:"form-group mt-3"},ot=["disabled"],nt=["value"],rt=["value"],it=["value"],dt={class:"modal-footer py-2"},ut=["disabled"],ct={key:0,class:"fas fa-spinner fa-spin mr-1"},bt={__name:"AdminList",setup(i){const D=fe(),b=X(),T=Se(),g=ee(),U=n([]),s=n({current_page:1,per_page:10,total:0,from:0,to:0,last_page:1}),k=n(""),R=n(!1),w=n(!1);n(!1);const x=n({}),d=n([]),o=n(!1),_={SUPERADMIN:1,ADMIN:2,USER:3,REVIEWER:4},f=n(""),V=n(!1),S=n([]),v=n(null),y=n(""),P=n(!1),te=Z(async()=>{if(!f.value||f.value.trim().length<2){S.value=[];return}V.value=!0;try{const{data:a}=await I.get("/api/users",{params:{search:f.value,per_page:10}});S.value=(a==null?void 0:a.data)||[]}catch{g.error("Gagal mencari user")}finally{V.value=!1}},350);K(f,()=>te());const ae=async()=>{var a,t,c;if(!(!v.value||!y.value)){if(((a=b.user)==null?void 0:a.role)!=="SUPERADMIN"){g.error("Hanya SUPERADMIN yang dapat mempromosikan role");return}P.value=!0;try{await I.patch(`/api/users/${v.value}/change-role`,{role:y.value}),g.success("Role berhasil dipromosikan"),await h(s.value.current_page),v.value=null,y.value="",f.value="",S.value=[],$("#adminPromoteModal").modal("hide")}catch(p){g.error(((c=(t=p==null?void 0:p.response)==null?void 0:t.data)==null?void 0:c.message)||"Gagal mempromosikan role")}finally{P.value=!1}}},h=async(a=1)=>{R.value=!0;try{const t=await I.get("/api/users",{params:{page:a,search:k.value,exclude_role:"User"}});U.value=t.data.data,s.value={...s.value,...t.data.meta,...t.data},T.setFrom(s.value.from||0),d.value=[],o.value=!1}catch(t){t.response&&t.response.status===401?(console.warn("Unauthorized. Logging out..."),b.logout()):console.error("Gagal memuat data Pengelola:",t)}finally{R.value=!1}},E=J(()=>(U.value||[]).filter(a=>{const t=a.roles||[];return a.role!=null?Number(a.role)!==_.USER:!t.some(c=>((c==null?void 0:c.name)||"").toLowerCase()==="user")})),le=J(()=>(s.value.current_page-1)*(s.value.per_page||10)),se=a=>{var t,c,p,l;return{...a,name:((t=a.employee)==null?void 0:t.full_name)||a.name,jabatan:((c=a.employee)==null?void 0:c.job_title)||"-",org_name:((l=(p=a.employee)==null?void 0:p.work_unit)==null?void 0:l.unit_name)||"-",formatted_created_at:a.formatted_created_at||he(a.created_at),role:a.role}},oe=()=>{v.value=null,y.value="",f.value="",S.value=[],$("#adminPromoteModal").modal("show")},ne=a=>{var t;w.value=!0,x.value={...a,...a.employee,id_work_unit:(t=a.employee)==null?void 0:t.id_work_unit,role_names:(a.roles||[]).map(c=>c.name)}},re=async a=>{if(confirm("Yakin ingin menghapus pengguna ini?"))try{await I.delete(`/api/users/${a}`),g.success("Pengguna berhasil dihapus"),E.value.length===1&&s.value.current_page>1?await h(s.value.current_page-1):await h(s.value.current_page)}catch{g.error("Gagal menghapus pengguna")}},ie=()=>{o.value=!o.value,o.value?d.value=E.value.map(a=>a.id):d.value=[]},de=a=>{const t=d.value.indexOf(a.id);t>=0?d.value.splice(t,1):d.value.push(a.id),o.value=d.value.length===E.value.length},ue=()=>{h(s.value.current_page)};return K(k,Z(()=>h(1),400)),me(()=>{h(),D.getWorkunitList()}),(a,t)=>{var c,p;return u(),m(M,null,[e("section",Ue,[e("div",Re,[e("div",Ee,[t[7]||(t[7]=e("h1",{class:"mb-2"},"Daftar Pengelola",-1)),e("div",Ie,[e("button",{class:"btn btn-primary btn-sm",onClick:oe,disabled:((c=L(b).user)==null?void 0:c.role)!=="SUPERADMIN",title:"Hanya SUPERADMIN yang bisa mempromosikan role"}," + Tambah Pengelola ",8,Me)])])])]),e("section",De,[e("div",we,[e("div",Pe,[e("div",Ae,[N(e("input",{"onUpdate:modelValue":t[0]||(t[0]=l=>k.value=l),type:"text",class:"form-control",placeholder:"Cari nama, email, NIP, atau unit kerja..."},null,512),[[Q,k.value]])]),e("div",Ne,[e("table",Ce,[e("thead",Te,[e("tr",null,[e("th",$e,[e("input",{type:"checkbox",checked:o.value,onChange:ie},null,40,Ve)]),t[8]||(t[8]=e("th",{style:{width:"40px"}},"#",-1)),t[9]||(t[9]=e("th",null,"Nama",-1)),t[10]||(t[10]=e("th",null,"Email",-1)),t[11]||(t[11]=e("th",null,"Role",-1))])]),e("tbody",null,[R.value?(u(),m("tr",je,t[12]||(t[12]=[e("td",{colspan:"7",class:"text-center"},"Memuat data...",-1)]))):E.value.length===0?(u(),m("tr",Be,t[13]||(t[13]=[e("td",{colspan:"7",class:"text-center"},"Tidak ada data Pengelola ditemukan.",-1)]))):(u(!0),m(M,{key:2},G(E.value,(l,A)=>(u(),pe(xe,{key:l.id,user:se(l),index:A+le.value,"select-all":o.value||d.value.includes(l.id),onToggleSelection:de,onEditUser:ne,onConfirmUserDeletion:re,onUserDeleted:ue},null,8,["user","index","select-all"]))),128))])])]),e("div",Le,[e("div",Ge,[e("div",We," Menampilkan "+r(s.value.from)+" - "+r(s.value.to)+" dari "+r(s.value.total)+' pengguna (role ≠ "User") ',1),e("ul",Fe,[e("li",{class:j(["page-item",{disabled:s.value.current_page===1}])},[e("a",{class:"page-link",href:"#",onClick:t[1]||(t[1]=B(l=>h(s.value.current_page-1),["prevent"]))},"«")],2),e("li",ze,[e("span",He," Halaman "+r(s.value.current_page)+" / "+r(s.value.last_page),1)]),e("li",{class:j(["page-item",{disabled:s.value.current_page===s.value.last_page}])},[e("a",{class:"page-link",href:"#",onClick:t[2]||(t[2]=B(l=>h(s.value.current_page+1),["prevent"]))},"»")],2)])])])])]),e("div",Oe,[e("div",qe,[e("div",Ke,[t[24]||(t[24]=e("div",{class:"modal-header py-2"},[e("h5",{class:"modal-title"},[e("i",{class:"fas fa-user-shield me-2"}),C("Tambah Pengelola (Promosi Role) ")]),e("button",{type:"button",class:"close","data-dismiss":"modal"},[e("span",null,"×")])],-1)),e("div",Je,[e("div",Qe,[t[14]||(t[14]=e("label",{class:"mb-1"},"Cari User",-1)),N(e("input",{"onUpdate:modelValue":t[3]||(t[3]=l=>f.value=l),type:"text",class:"form-control form-control-sm",placeholder:"Ketik nama atau email…"},null,512),[[Q,f.value]]),t[15]||(t[15]=e("small",{class:"text-muted"},"Hanya SUPERADMIN yang bisa mempromosikan role.",-1))]),e("div",Ye,[e("table",Ze,[t[18]||(t[18]=e("thead",null,[e("tr",null,[e("th",{style:{width:"36px"}}),e("th",null,"Nama"),e("th",null,"Email"),e("th",null,"Role Saat Ini")])],-1)),e("tbody",null,[V.value?(u(),m("tr",Xe,t[16]||(t[16]=[e("td",{colspan:"4",class:"text-center"},"Mencari…",-1)]))):S.value.length===0?(u(),m("tr",et,t[17]||(t[17]=[e("td",{colspan:"4",class:"text-center"},"Belum ada hasil. Ketik kata kunci di atas.",-1)]))):Y("",!0),(u(!0),m(M,null,G(S.value,l=>{var A,W,F,z,H,O;return u(),m("tr",{key:l.id,class:j({"table-active":v.value===l.id}),style:{cursor:"pointer"},onClick:q=>v.value=l.id},[e("td",null,[N(e("input",{type:"radio",name:"candidate",value:l.id,"onUpdate:modelValue":t[4]||(t[4]=q=>v.value=q),onClick:t[5]||(t[5]=B(()=>{},["stop"]))},null,8,at),[[ge,v.value]])]),e("td",null,[e("strong",null,r(((A=l.employee)==null?void 0:A.full_name)||l.name),1),e("div",lt,r(((W=l.employee)==null?void 0:W.job_title)||"-")+" • "+r(((z=(F=l.employee)==null?void 0:F.work_unit)==null?void 0:z.unit_name)||"-"),1)]),e("td",null,r(l.email),1),e("td",null,r(l.role&&String(l.role)||((O=(H=l.roles)==null?void 0:H[0])==null?void 0:O.name)||"-"),1)],10,tt)}),128))])])]),e("div",st,[t[20]||(t[20]=e("label",{class:"mb-1"},"Role Target",-1)),N(e("select",{class:"form-control form-control-sm","onUpdate:modelValue":t[6]||(t[6]=l=>y.value=l),disabled:((p=L(b).user)==null?void 0:p.role)!=="SUPERADMIN"},[t[19]||(t[19]=e("option",{disabled:"",value:""},"— Pilih role —",-1)),e("option",{value:_.SUPERADMIN},"SUPERADMIN",8,nt),e("option",{value:_.ADMIN},"ADMIN",8,rt),e("option",{value:_.REVIEWER},"REVIEWER",8,it)],8,ot),[[ve,y.value]]),t[21]||(t[21]=e("small",{class:"text-muted"},"USER tidak tersedia di sini karena fokusnya promosi.",-1))])]),e("div",dt,[t[23]||(t[23]=e("button",{type:"button",class:"btn btn-default btn-sm","data-dismiss":"modal"},"Tutup",-1)),e("button",{type:"button",class:"btn btn-primary btn-sm",disabled:!v.value||!y.value||P.value,onClick:ae},[P.value?(u(),m("i",ct)):Y("",!0),t[22]||(t[22]=C(" Simpan "))],8,ut)])])])])])],64)}}};export{bt as default};
