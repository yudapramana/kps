import{z as q,A as u,y as T,O as J,V as z,B as l,C as i,ax as Y,D as s,S as P,as as V,I as C,U as y,ay as S,K as d,J as c,a as b,aA as Q,aC as X}from"./AuthUserStore-67h2FHdL.js";import{S as W}from"./sweetalert2.esm.all-9Qm2jZ7z.js";const Z={class:"content"},ee={class:"container-fluid"},se={class:"card"},te={class:"card-header"},ae={class:"card-body table-responsive p-0"},ne={class:"table table-bordered table-hover text-sm"},oe={key:0},le={key:1},ie={class:"text-center"},re=["onClick"],ue={class:"modal fade",id:"rolePermissionModal",tabindex:"-1",role:"dialog"},de={class:"modal-dialog modal-lg",role:"document"},ce={class:"modal-content"},me={class:"modal-header py-2 bg-primary text-white"},ve={key:0,class:"d-block"},ge={class:"text-white"},pe={class:"modal-body",style:{background:"#f4f6f9"}},he={key:0,class:"text-center my-3"},fe={key:1},ye={class:"mb-2"},be={key:0,class:"text-center text-muted py-4"},ke={class:"card-header py-2 bg-dark text-white d-flex align-items-center"},_e={class:"custom-control custom-checkbox mb-0"},xe=["id","checked","onChange"],we=["for"],Ae={class:"ml-1",style:{opacity:".9"}},Pe={class:"card-body py-2"},Ce=["id","value"],Se=["for"],Re={class:"text-muted"},Ee={class:"text-muted text-sm mb-0"},Le={class:"modal-footer py-2"},Me=["disabled"],Ne={key:0,class:"fas fa-spinner fa-spin mr-1"},Ge={key:1,class:"fas fa-save mr-1"},Ve={__name:"PermissionRoleList",setup(Ie){const R=q(),k=u([]),_=u(!1),g=u(""),m=u(null),x=u(!1),p=u(!1),h=u(""),w=u([]),A=u([]),r=u([]),j=async()=>{_.value=!0;try{const a=await b.get("/api/v1/roles-simple");k.value=a.data||[]}catch(a){console.error("Gagal memuat roles:",a),a.response&&a.response.status===401&&R.logout()}finally{_.value=!1}},E=T(()=>{if(!g.value)return k.value;const a=g.value.toLowerCase();return k.value.filter(e=>e.name&&e.name.toLowerCase().includes(a)||e.slug&&e.slug.toLowerCase().includes(a))});J(g,X(()=>{},250));const L=async()=>{try{const a=await b.get("/api/v1/permissions-simple");w.value=a.data||[]}catch(a){console.error("Gagal memuat permissions:",a)}},M={"manage.core":"CORE","manage.master":"MASTER DATA","manage.event":"EVENT","manage.event.participant":"PESERTA","manage.event.judges":"HAKIM","manage.event.scoring":"PENILAIAN","manage.event.scores":"REKAP NILAI","manage.event.ranking":"RANKING","manage.event.results":"PEROLEHAN JUARA"},N=["manage.core","manage.master","manage.event","manage.event.participant","manage.event.judges","manage.event.scoring","manage.event.scores","manage.event.ranking","manage.event.results"],G=new Set(["manage.core","manage.master","manage.event","manage.event.participant","manage.event.judges","manage.event.scoring","manage.event.scores","manage.event.ranking","manage.event.results"]),O=(a="")=>{const e=String(a||"");return e.startsWith("manage.event.participant")?"manage.event.participant":e.startsWith("manage.event.judges")?"manage.event.judges":e.startsWith("manage.event.scoring")?"manage.event.scoring":e.startsWith("manage.event.scores")?"manage.event.scores":e.startsWith("manage.event.ranking")?"manage.event.ranking":e.startsWith("manage.event.results")?"manage.event.results":e.startsWith("manage.event")?"manage.event":e.startsWith("manage.core")?"manage.core":e.startsWith("manage.master")?"manage.master":"other"},B=(a,e)=>{const o=String(a.slug||""),t=String(e.slug||""),n=G.has(o),v=G.has(t);if(n!==v)return n?-1:1;const I=o.split(".").length,U=t.split(".").length;return I!==U?I-U:o.localeCompare(t)},f=T(()=>{const a=(h.value||"").toLowerCase().trim(),e={};N.forEach(t=>{e[t]={key:t,title:M[t]||t,permissions:[]}}),e.other={key:"other",title:"LAINNYA",permissions:[]};const o=t=>{if(!a)return!0;const n=(t.slug||"").toLowerCase(),v=(t.name||"").toLowerCase();return n.includes(a)||v.includes(a)};for(const t of w.value||[]){if(!o(t))continue;const n=O(t.slug);e[n]||(e[n]={key:n,title:M[n]||n,permissions:[]}),e[n].permissions.push(t)}return Object.values(e).forEach(t=>t.permissions.sort(B)),[...N.map(t=>e[t]).filter(t=>t&&t.permissions.length),...e.other.permissions.length?[e.other]:[]]}),D=async a=>{h.value="",m.value=a,x.value=!0,r.value=[],A.value=[],$("#rolePermissionModal").modal("show");try{w.value.length||await L();const e=await b.get("/api/v1/permission-roles",{params:{role_id:a.id,per_page:1e3}});A.value=e.data.data||[],r.value=A.value.map(o=>o.permission_id)}catch(e){console.error("Gagal memuat permission role:",e),e.response&&e.response.status===401&&R.logout()}finally{x.value=!1}},H=async()=>{var a,e;if(m.value){p.value=!0;try{await b.post(`/api/v1/roles/${m.value.id}/sync-permissions`,{permission_ids:r.value}),W.fire({icon:"success",title:"Hak akses berhasil disimpan.",showConfirmButton:!1,timer:1400}),$("#rolePermissionModal").modal("hide")}catch(o){console.error("Gagal sync permissions:",o),W.fire("Gagal",((e=(a=o.response)==null?void 0:a.data)==null?void 0:e.message)||"Gagal menyimpan hak akses.","error")}finally{p.value=!1}}},K=a=>{const e=f.value.find(o=>o.key===a);return!e||!e.permissions.length?!1:e.permissions.every(o=>r.value.includes(o.id))},F=(a,e)=>{const o=f.value.find(n=>n.key===a);if(!o)return;const t=o.permissions.map(n=>n.id);e?r.value=Array.from(new Set([...r.value,...t])):r.value=r.value.filter(n=>!t.includes(n))};return z(()=>{j(),L()}),(a,e)=>{var o;return i(),l(y,null,[e[17]||(e[17]=Y('<section class="content-header"><div class="container-fluid"><div class="d-flex justify-content-between align-items-center"><div><h1 class="mb-1">Pengaturan Hak Akses Role</h1><p class="mb-0 text-muted text-sm"> Pilih role lalu atur menu / permission yang boleh diakses. </p></div></div></div></section>',1)),s("section",Z,[s("div",ee,[s("div",se,[s("div",te,[P(s("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>g.value=t),type:"text",class:"form-control",placeholder:"Cari nama role atau slug..."},null,512),[[V,g.value]])]),s("div",ae,[s("table",ne,[e[6]||(e[6]=s("thead",{class:"thead-light"},[s("tr",null,[s("th",{style:{width:"40px"}},"#"),s("th",null,"Nama Role"),s("th",null,"Slug"),s("th",{style:{width:"80px"}},"Aksi")])],-1)),s("tbody",null,[_.value?(i(),l("tr",oe,e[3]||(e[3]=[s("td",{colspan:"4",class:"text-center"},"Memuat data role...",-1)]))):E.value.length===0?(i(),l("tr",le,e[4]||(e[4]=[s("td",{colspan:"4",class:"text-center"},"Tidak ada role ditemukan.",-1)]))):C("",!0),(i(!0),l(y,null,S(E.value,(t,n)=>(i(),l("tr",{key:t.id},[s("td",null,c(n+1),1),s("td",null,c(t.name),1),s("td",null,[s("code",null,c(t.slug),1)]),s("td",ie,[s("button",{class:"btn btn-sm btn-outline-success",title:"Atur Permission",onClick:v=>D(t)},e[5]||(e[5]=[s("i",{class:"fas fa-sliders-h"},null,-1)]),8,re)])]))),128))])])])])]),s("div",ue,[s("div",de,[s("div",ce,[s("div",me,[s("div",null,[e[10]||(e[10]=s("h5",{class:"modal-title mb-0"},[s("i",{class:"fas fa-user-shield mr-1"}),d(" Pengaturan Hak Akses ")],-1)),m.value?(i(),l("small",ve,[e[7]||(e[7]=d(" Role: ")),s("strong",null,c(m.value.name),1),e[8]||(e[8]=d(" (")),s("code",ge,c(m.value.slug),1),e[9]||(e[9]=d(") "))])):C("",!0)]),e[11]||(e[11]=s("button",{type:"button",class:"close","data-dismiss":"modal"},[s("span",{class:"text-white"},"Ã—")],-1))]),s("div",pe,[x.value?(i(),l("div",he,e[12]||(e[12]=[s("i",{class:"fas fa-spinner fa-spin mr-1"},null,-1),d(" Memuat permission... ")]))):(i(),l("div",fe,[s("div",ye,[P(s("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>h.value=t),type:"text",class:"form-control form-control-sm",placeholder:"Cari permission... (contoh: manage.event.judges)"},null,512),[[V,h.value]])]),f.value.length===0?(i(),l("div",be," Tidak ada permission sesuai pencarian. ")):C("",!0),(i(!0),l(y,null,S(f.value,t=>(i(),l("div",{key:t.key,class:"card mb-3 border-0 shadow-sm"},[s("div",ke,[s("div",_e,[s("input",{type:"checkbox",class:"custom-control-input",id:"group-"+t.key,checked:K(t.key),onChange:n=>F(t.key,n.target.checked)},null,40,xe),s("label",{class:"custom-control-label font-weight-bold",for:"group-"+t.key},[d(c(t.title)+" ",1),s("small",Ae,"("+c(t.key)+")",1)],8,we)])]),s("div",Pe,[(i(!0),l(y,null,S(t.permissions,n=>(i(),l("div",{key:n.id,class:"custom-control custom-checkbox mb-1"},[P(s("input",{type:"checkbox",class:"custom-control-input",id:"perm-"+n.id,value:n.id,"onUpdate:modelValue":e[2]||(e[2]=v=>r.value=v)},null,8,Ce),[[Q,r.value]]),s("label",{class:"custom-control-label",for:"perm-"+n.id},[d(c(n.name)+" ",1),s("small",Re,"("+c(n.slug)+")",1)],8,Se)]))),128))])]))),128)),s("p",Ee,[e[13]||(e[13]=d(" Centang permission yang boleh diakses oleh role ")),s("strong",null,c((o=m.value)==null?void 0:o.name),1),e[14]||(e[14]=d(". "))])]))]),s("div",Le,[e[16]||(e[16]=s("button",{type:"button",class:"btn btn-secondary btn-sm","data-dismiss":"modal"}," Batal ",-1)),s("button",{type:"button",class:"btn btn-success btn-sm",disabled:p.value,onClick:H},[p.value?(i(),l("i",Ne)):(i(),l("i",Ge)),e[15]||(e[15]=d(" Simpan Pengaturan "))],8,Me)])])])])])],64)}}};export{Ve as default};
